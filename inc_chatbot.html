

<!-- Hurra Lingo Chatbot Widget - Bu kodu WordPress sitenize ekleyin -->
<style>
#hurra-chat-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  z-index: 99999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.3s, box-shadow 0.3s;
}
#hurra-chat-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}
#hurra-chat-btn svg {
  width: 28px;
  height: 28px;
  fill: white;
}
#hurra-chat-box {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 370px;
  max-width: calc(100vw - 40px);
  height: 500px;
  max-height: calc(100vh - 120px);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 99999;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
#hurra-chat-box.open { display: flex; }
#hurra-chat-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px 20px;
  font-weight: 600;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
#hurra-chat-header span { display: flex; align-items: center; gap: 10px; }
#hurra-chat-header .status { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; }
#hurra-chat-close {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  line-height: 1;
  padding: 0;
}
#hurra-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: #f8fafc;
}
.hurra-msg {
  margin-bottom: 12px;
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  word-wrap: break-word;
}
.hurra-msg.bot {
  background: white;
  color: #334155;
  border: 1px solid #e2e8f0;
  border-bottom-left-radius: 4px;
  margin-right: auto;
}
.hurra-msg.user {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-bottom-right-radius: 4px;
  margin-left: auto;
}
.hurra-msg.typing {
  background: white;
  border: 1px solid #e2e8f0;
  color: #94a3b8;
  font-style: italic;
}
#hurra-chat-input-area {
  padding: 12px 16px;
  background: white;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 10px;
}
#hurra-chat-input {
  flex: 1;
  border: 1px solid #e2e8f0;
  border-radius: 24px;
  padding: 12px 18px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
}
#hurra-chat-input:focus { border-color: #667eea; }
#hurra-chat-send {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}
#hurra-chat-send:hover { transform: scale(1.05); }
#hurra-chat-send:disabled { opacity: 0.6; cursor: not-allowed; }
#hurra-chat-send svg { width: 20px; height: 20px; fill: white; }
.hurra-payment-btn {
  display: block;
  width: 100%;
  margin-top: 10px;
  padding: 12px 14px;
  border-radius: 12px;
  text-align: center;
  font-weight: 700;
  text-decoration: none;
  background: #22c55e;
  color: #fff;
}
.hurra-payment-btn:hover { filter: brightness(0.95); }

.hurra-msg ul li::marker {
  color: #667eea;
}
</style>

<button id="hurra-chat-btn" aria-label="Sohbet">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
</button>

<div id="hurra-chat-box">
  <div id="hurra-chat-header">
    <span><span class="status"></span><span id="hurra-header-text">Hurra Lingo Asistan</span></span>
    <button id="hurra-chat-close">&times;</button>
  </div>
  <div id="hurra-chat-messages"></div>
  <div id="hurra-chat-input-area">
    <input type="text" id="hurra-chat-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." autocomplete="off">
    <button id="hurra-chat-send">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<script>
(function() {
  const PROXY_URL = "/inc_chat-proxy.php";
  const chatBtn = document.getElementById("hurra-chat-btn");
  const chatBox = document.getElementById("hurra-chat-box");
  const closeBtn = document.getElementById("hurra-chat-close");
  const messagesDiv = document.getElementById("hurra-chat-messages");
  const input = document.getElementById("hurra-chat-input");
  const sendBtn = document.getElementById("hurra-chat-send");

  // URL'den dili al: ?lng=en
function getLng() {
  const host = location.host.toLowerCase();

  // hurralingo.com landing: her zaman EN UI
  if (host.includes("hurralingo.com") && !host.includes("hurralingo.app")) return "en";

  // hurralingo.app: query'e gÃ¶re UI dili
  const q = (new URLSearchParams(window.location.search).get("lng") || "").toLowerCase();
  if (q) return q;

  // query yoksa fallback
  return "tr";
}


  function getDefaultLangBySite() {
  const host = location.host.toLowerCase();
  const path = location.pathname.toLowerCase();

  // hurraturkiye.com -> TR
  if (host.includes("hurraturkiye.com")) return "tr";

  // hurralingo.com -> EN default, ama /tr ve /de Ã¶zel
  if (host.includes("hurralingo.com")) {
    if (path.startsWith("/tr")) return "tr";
    if (path.startsWith("/de")) return "de";
    return "en";
  }

  // fallback
  return "tr";
}


  // Metin sÃ¶zlÃ¼ÄŸÃ¼
  const i18n = {
    tr: {
      greeting:    "Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim?",
      placeholder: "MesajÄ±nÄ±zÄ± yazÄ±n...",
      typing:      "YazÄ±yor...",
      payBtn:      "ðŸ’³ Ã–deme Yap",
      errorConn:   "BaÄŸlantÄ± hatasÄ±, lÃ¼tfen tekrar deneyin.",
      errorGen:    "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin.",
      header:      "Hurra Lingo Asistan"
    },
    en: {
      greeting:    "Hello! How can I help you?",
      placeholder: "Type your message...",
      typing:      "Typing...",
      payBtn:      "ðŸ’³ Make Payment",
      errorConn:   "Connection error, please try again.",
      errorGen:    "An error occurred, please try again.",
      header:      "Hurra Lingo Assistant"
    },
    de: {
      greeting:    "Hallo! Wie kann ich Ihnen helfen?",
      placeholder: "Nachricht eingeben...",
      typing:      "Schreibt...",
      payBtn:      "ðŸ’³ Zahlung vornehmen",
      errorConn:   "Verbindungsfehler, bitte erneut versuchen.",
      errorGen:    "Ein Fehler ist aufgetreten, bitte erneut versuchen.",
      header:      "Hurra Lingo Assistent"
    },
    fr: {
      greeting:    "Bonjour\u00a0! Comment puis-je vous aider\u00a0?",
      placeholder: "Tapez votre message...",
      typing:      "En train d\u2019\u00e9crire...",
      payBtn:      "ðŸ’³ Effectuer le paiement",
      errorConn:   "Erreur de connexion, veuillez r\u00e9essayer.",
      errorGen:    "Une erreur s\u2019est produite, veuillez r\u00e9essayer.",
      header:      "Assistant Hurra Lingo"
    }
  };

  function applyUiLanguage() {
    const lng = getLng();
    const t = i18n[lng] || i18n.tr;

    // placeholder
    input.placeholder = t.placeholder;

    // header
    const headerText = document.getElementById("hurra-header-text");
    if (headerText) headerText.textContent = t.header;

    // greeting: data-role="greeting" ile iÅŸaretlenmiÅŸ node'u gÃ¼ncelle
    const greetingNode = messagesDiv.querySelector("[data-role='greeting']");
    if (greetingNode) {
      greetingNode.innerHTML = formatMessage(t.greeting);
    }
  }

  // Sen otomatik aÃ§Ä±k kalsÄ±n istemiÅŸsin: bunu korudum
  chatBox.classList.add("open");

  // Ä°lk greeting'i ekle (data-role ile iÅŸaretle)
  if (messagesDiv.children.length === 0) {
    const t = i18n[getLng()] || i18n.tr;
    const greetDiv = document.createElement("div");
    greetDiv.className = "hurra-msg bot";
    greetDiv.setAttribute("data-role", "greeting");
    greetDiv.innerHTML = formatMessage(t.greeting);
    messagesDiv.appendChild(greetDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  let isOpen = true;
  let isLoading = false;
  let paymentButtonShown = false;

  function getSessionId() {
    let sid = localStorage.getItem("hurra_sessionId");
    if (!sid) {
      sid = "sess_" + Math.random().toString(36).slice(2) + "_" + Date.now();
      localStorage.setItem("hurra_sessionId", sid);
    }
    return sid;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatMessage(text) {
    if (!text) return "";

    text = escapeHtml(text);

    // **kalÄ±n**
    text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

    // * madde satÄ±rlarÄ±nÄ± listeye Ã§evir
    if (text.includes("* ")) {
      const lines = text.split("\n");
      let inList = false;
      let formatted = "";

      lines.forEach(line => {
        if (line.trim().startsWith("* ")) {
          if (!inList) {
            formatted += "<ul style='padding-left:18px; margin:6px 0;'>";
            inList = true;
          }
          formatted += "<li style='margin-bottom:4px;'>" + line.trim().substring(2) + "</li>";
        } else {
          if (inList) {
            formatted += "</ul>";
            inList = false;
          }
          formatted += line + "<br>";
        }
      });

      if (inList) formatted += "</ul>";
      return formatted;
    }

    return text.replace(/\n/g, "<br>");
  }

  function addMessage(text, type) {
    const div = document.createElement("div");
    div.className = "hurra-msg " + type;
    div.innerHTML = formatMessage(text);
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    return div;
  }

  function addPaymentButton(url) {
    const wrap = document.createElement("div");
    wrap.className = "hurra-msg bot";
    wrap.style.background = "transparent";
    wrap.style.border = "none";
    wrap.style.padding = "0";
    wrap.style.marginTop = "6px";
    wrap.style.maxWidth = "100%";

    const a = document.createElement("a");
    a.href = url;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.className = "hurra-payment-btn";
    const t = i18n[getLng()] || i18n.tr;
    a.textContent = t.payBtn;

    wrap.appendChild(a);
    messagesDiv.appendChild(wrap);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function showTyping() {
    const t = i18n[getLng()] || i18n.tr;
    return addMessage(t.typing, "bot typing");
  }

  async function sendMessage(msg) {
    if (!msg.trim() || isLoading) return;

    addMessage(msg, "user");
    input.value = "";
    isLoading = true;
    sendBtn.disabled = true;
    const typingEl = showTyping();

    try {
      const host = location.host.toLowerCase();
const defaultLanguage =
  host.includes("hurralingo.app")
    ? (getLng() || "en")          // APP: dil seÃ§imine gÃ¶re
    : getDefaultLangBySite();     // diÄŸerleri: site kuralÄ±



const res = await fetch(PROXY_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    message: msg,
    sessionId: getSessionId(),
    defaultLanguage: defaultLanguage,
    allowedLanguages: [defaultLanguage, "en"]
  })
});


      const data = await res.json();
      typingEl.remove();

      let output = "";
      if (Array.isArray(data) && data[0] && data[0].output) {
        output = data[0].output;
      } else if (data.output) {
        output = data.output;
      } else {
        const t = i18n[getLng()] || i18n.tr;
        output = t.errorGen;
      }

      const PAY_URL = "https://www.hurralingo.com/prices/";
      const hasPayLink = output && output.includes(PAY_URL);

      // URLâ€™yi mesajdan kaldÄ±r
      if (hasPayLink) {
        output = output
          .replace(PAY_URL, "")
          .replace(/\n{2,}/g, "\n")
          .trim();
      }

      if (output) addMessage(output, "bot");
      if (hasPayLink) addPaymentButton(PAY_URL);

    } catch (err) {
      typingEl.remove();
      const t = i18n[getLng()] || i18n.tr;
      addMessage(t.errorConn, "bot");
    }

    isLoading = false;
    sendBtn.disabled = false;
    input.focus();
  }

  chatBtn.addEventListener("click", function() {
    isOpen = !isOpen;
    chatBox.classList.toggle("open", isOpen);
    if (isOpen) {
      applyUiLanguage();
      input.focus();
    }
  });

  closeBtn.addEventListener("click", function() {
    isOpen = false;
    chatBox.classList.remove("open");
  });

  sendBtn.addEventListener("click", function() {
    sendMessage(input.value);
  });

  input.addEventListener("keypress", function(e) {
    if (e.key === "Enter") sendMessage(input.value);
  });

  // Sayfa ilk aÃ§Ä±lÄ±ÅŸta UI dilini uygula
  applyUiLanguage();
})();
</script>
